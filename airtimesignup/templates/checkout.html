{% extends "layout.html" %}
{% block title %}Checkout{% endblock %}

{% block body %}
	<form action="/confirm" method="POST" id="checkout-form" class="checkout">
    <h1>Checkout</h1>

    <h2>Your Configuration</h2>

    {% include "packages/_package_selection.html" %}

    <hr>
    <p>
       SUM: {{sum_total}} {{ currency.symbol }}/m<br>
    	<div id="with-vat">
         VAT: {{vat}} {{ currency.symbol }}/m<br>
         TOTAL: {{total}} {{ currency.symbol }}/m<br>
    	</div>
    	<div id="without-vat" style="display:none">
         VAT: 0,00 {{ currency.symbol }}/m<br>
         TOTAL: {{sum_total}} {{ currency.symbol }}/m<br>
    	</div>

    </p>

    <h2>Billing details</h2>
        {% if not current_user.is_authenticated() %}        
            <button id="browserid-login" class="btn btn-primary">Sign in</button> using <a href="http://www.mozilla.org/en-US/persona/" target="_blank">mozilla persona</a>
        {% endif %}

        {% if current_user.is_authenticated() %}
        <div class="row">
        	<div class="col-md-4">
	        	<dl class="dl-horizontal">
		        	<dt>User Account</dt>
		        	<dd>{{current_user.email}} <a id="browserid-logout">change</a></dd>

                    <div class="form-group">
                        <dt><label for="domain" class="control-label">desired Domain</label></dt>
                        <dd><input id="domain" type="text" name="domain" class="form-control"></dd>
                    </div>

		        	<dt>Bill to</dt>
		            <dd>
                        <div class="form-group">
                            <input type="radio" name="bill-selector" value="vat" checked="checked"> VAT Nr.<br>
		        		    <input id="vatfield" type="text" name="vat-nr" disabled="disabled" class="form-control disabled">
                        </div>
                        <div class="form-group">
		        	         <input type="radio" name="bill-selector" value="address" > Address<br>
		        	         <textarea id="addressfield" name="address" disabled="disabled" class="form-control disabled"></textarea>
                        </div>
		        	</dd>
	        	</dl>
        	</div>
        	<div class="col-md-4" id="vat-test">
        		<h3 class="loading" style="display:none">loading</h3>

        		<div class="loaded fine">
        		</div>
        		<div class="loaded invalid">
        			<div class="alert alert-danger">
        				<strong>Failure</strong> this VAT is not valid.
        			</div>
        		</div>

        	</div>
        </div>

        <div>
            <button type="submit" class="btn btn-primary" id="submit-button">Submit</button>
        </div>

        {% endif %}
        </form>
       
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="https://login.persona.org/include.js" type="text/javascript"></script>
        <script type="text/javascript">{{ auth_script|safe }}</script>

        <script type="text/javascript">
        $(function(){
        	$("input:radio").change(function(){
        		var selected = $("input:radio[name=bill-selector]:checked" ).val();
        		if (selected === "address") {
        			$("#addressfield").attr("disabled", false)
        			$("#addressfield").removeClass("disabled")

        			$("#vatfield").attr("disabled", "disabled")
        			$("#vatfield").addClass("disabled")
        		} else {
        			$("#vatfield").attr("disabled", false)
        			$("#vatfield").removeClass("disabled")

        			$("#addressfield").attr("disabled", "disabled")
        			$("#addressfield").addClass("disabled")
        		}	
        	}).change();

            function validate_form(form){
                var $this = $(form),
                    params = {},
                    valid = true;

                $.each($this.serializeArray(), function(idx, item){
                    params[item.name] = item.value;
                });

                $this.find(".has-error").removeClass("has-error");

                if (!$.trim(params["domain"])) {
                    $("#domain").parent().parent().addClass("has-error");
                    valid = false;
                }

                console.log(params);

                if ((params["bill-selector"] === "vat")){
                    if (
                        $("#vatfield").data("vat_checker") !== "valid")) {
                    
                        $("#vatfield").parent().addClass("has-error");
                        valid = false;
                    } 
                } else if (!$.trim(params["address"])){
                    $("#addressfield").parent().addClass("has-error");
                    valid = false;
                } else {
                    valid = false;
                }
                return valid;
            }

            $("#checkout-form").bind("submit", function(){
                return validate_form(this);
            });

	        $('#vatfield').bind('keyup', function(){
			    var $this = $(this),
			    	value = $.trim($(this).val()),
			    	$target = $("#vat-test"),
			    	delay = 1500; // 1.5 seconds delay after last input

			    //only continue if it actually changed
			    if (value === $this.data("last-tested")) {
			    	return;
			    }
			    $this.data("last-tested", value)
                $this.data("vat_checker", false);

			    // only continue if there is some data in it
			    $target.find(".loaded").hide();
			    if (!value){
			    	return
			    }

			    $target.find(".loading").show();

			    clearTimeout($this.data('timer'));
			    $this.data('timer', setTimeout(function(){
			        $this.removeData('timer');
			        $.getJSON("/checkvat/" + $('#vatfield').val(), function(res) {
			        		$target.find(".loading").hide();
			        		$("#without-vat").hide();
			        		$("#with-vat").show();

			        		if (! res.valid){
			        			$target.find(".invalid").show();
			        		} else {
                                $this.data("vat_checker", "valid");
                                $this.parent().removeClass("has-error").addClass("has-success")
			        			var success = $('<div class="alert alert-success"><strong>VAT found</strong><br></div>')

			        			var address = $("<address>").html(res.name + "<br>" + res.address.replace("\n", "<br>"))
			        			success.append(address)
			        			$target.find(".fine").show().html(success);
			        			$("#without-vat").fadeIn(1000);
			        			$("#with-vat").hide();
			        		}
			        });
			    }, delay));
			});
        });
        </script>
{% endblock %}
